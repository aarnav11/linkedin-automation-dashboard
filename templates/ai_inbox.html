{% extends "base.html" %}
{% block title %}AI Inbox - LinkedIn Automation{% endblock %}

{% block content %}
<div class="container">
    <div class="page-grid">
        <div>
            <div class="card">
                <div class="card-header">
                    <h4><i class="fas fa-robot"></i> AI Inbox Processing</h4>
                </div>
                <div class="card-body">

                    <p class="text-muted">Process LinkedIn messages with AI-generated intelligent responses.</p>
                    
                    <div class="text-center">
                        <form method="POST" id="inboxForm">
                            <button type="submit" class="btn btn-primary btn-lg" id="processBtn">
                                <i class="fas fa-play"></i> Start Inbox Processing
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <div id="processingStatus" class="card" style="display: none;">
                <div class="card-header">
                    <h5><i class="fas fa-cogs"></i> Processing Status</h5>
                </div>
                <div class="card-body">
                    <div id="statusMessage" class="text-center">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <p class="mt-2">Initializing inbox processing...</p>
                    </div>
                    <div class="progress mt-2" style="display: none;" id="progressBar">
                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div id="resultsSection" class="card" style="display: none;">
                <div class="card-header">
                    <h5><i class="fas fa-envelope-open-text"></i> Processing Results</h5>
                </div>
                <div class="card-body" id="resultsContent">
                    </div>
            </div>
        </div>

        <div>
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-star"></i> AI Features</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li class="mb-2"><i class="fas fa-check text-success"></i> Smart Context Analysis</li>
                        <li class="mb-2"><i class="fas fa-check text-success"></i> Professional Tone</li>
                        <li class="mb-2"><i class="fas fa-check text-success"></i> Personalized Responses</li>
                        <li class="mb-2"><i class="fas fa-check text-success"></i> Safe, Manual Approval</li>
                    </ul>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h5 class="text-warning"><i class="fas fa-shield-alt"></i> Safety Notice</h5>
                </div>
                <div class="card-body">
                     <ul class="list-unstyled">
                        <li><i class="fas fa-exclamation-triangle text-warning"></i> Always review AI responses.</li>
                        <li><i class="fas fa-exclamation-triangle text-warning"></i> Monitor for accuracy and tone.</li>
                        <li><i class="fas fa-exclamation-triangle text-warning"></i> Use with trusted contacts first.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentProcessId = null;
let statusInterval = null;

// Check client status on page load
document.addEventListener('DOMContentLoaded', function() {
    {% if current_inbox_process %}
    currentProcessId = "{{ current_inbox_process }}";
    document.getElementById('processingStatus').style.display = 'block';
    startStatusMonitoring();
    {% endif %}
});

function startStatusMonitoring() {
    if (!currentProcessId) return;

    statusInterval = setInterval(() => {
        fetch(`/inbox_results/${currentProcessId}`)
            .then(response => response.json())
            .then(data => {
                updateProcessingStatus(data);
            })
            .catch(error => {
                console.error('Error fetching inbox results:', error);
            });
    }, 3000);
}

function updateProcessingStatus(data) {
    const statusDiv = document.getElementById('statusMessage');
    const progressBar = document.getElementById('progressBar');
    
    if (data.error) {
        statusDiv.innerHTML = `<i class="fas fa-times-circle text-danger fa-2x"></i><p class="mt-2 text-danger">Processing Failed: ${data.error}</p>`;
        clearInterval(statusInterval);
        return;
    }

    if (data.status === 'completed') {
        statusDiv.innerHTML = `<i class="fas fa-check-circle text-success fa-2x"></i><p class="mt-2 text-success">Inbox processing completed!</p>`;
        displayResults(data);
        clearInterval(statusInterval);
    } else if (data.status === 'processing') {
        statusDiv.innerHTML = `<i class="fas fa-cogs fa-spin fa-2x"></i><p class="mt-2">Processing inbox messages...</p>`;
        if (data.progress) {
            progressBar.style.display = 'block';
            const percentage = Math.round((data.progress.processed / data.progress.total) * 100);
            progressBar.querySelector('.progress-bar').style.width = percentage + '%';
            progressBar.querySelector('.progress-bar').textContent = `${data.progress.processed}/${data.progress.total}`;
        }
    } else {
        statusDiv.innerHTML = `<i class="fas fa-spinner fa-spin fa-2x"></i><p class="mt-2">Initializing...</p>`;
    }
}

function displayResults(data) {
    const resultsContent = document.getElementById('resultsContent');
    const resultsSection = document.getElementById('resultsSection');
    
    if (!data.messages || data.messages.length === 0) {
        resultsContent.innerHTML = `<div class="text-center text-muted"><i class="fas fa-inbox fa-2x mb-2"></i><p>No new messages found to process.</p></div>`;
    } else {
        let html = `...`; // Original result rendering logic here
        resultsContent.innerHTML = html;
    }
    
    resultsSection.style.display = 'block';
}

// Other functions like showAlert, form submission, etc. remain here.
</script>
{% endblock %}